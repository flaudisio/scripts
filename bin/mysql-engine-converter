#!/bin/bash
#
# mysql-engine-converter
# Conversor de Engines de tabelas do MySQL.
#
# Autor     : Flaudisio Tolentino <flaudisio@flaudisio.com>
# Data      : Wed Jul 17 18:27:32 BRT 2013
# Licença   : GPLv2
#
##

## Configurações

ProgramName="mysql-engine-converter"
ProgramVersion="0.1.1"

EngineFrom="MyISAM"
EngineTo="InnoDB"

MysqlHost="localhost"
MysqlPort="3306"
MysqlBase=""
MysqlUser="root"
MysqlPass=""

MysqlDumpFile=""


##
## Funções
##

#
# Funções de erros
#
# die()
# throw_arg_error()
#
die() { [ "$1" ] && echo -e "$*" >&2 ; exit 1 ; }

throw_arg_error() { die "fatal: parâmetro $1 exige um operador." ; }

#
# mysql_cmd()
#
mysql_cmd() {
    local query="$*"

    mysql -s -N -u$MysqlUser -p$MysqlPass -e "$query" ||
        return 1

    return 0
}

#
# backup_db()
#
backup_db() {
    local backupFile="./${MysqlBase}-$( date +'%Y%m%d-%H%M%S' ).sql"

    mysqldump -u$MysqlUser -p$MysqlPass $MysqlBase > $backupFile ||
        die

    echo "Backup salvo com sucesso: '${backupFile}'."
}

#
# update_tables()
#
update_tables() {
    local query tableList table

    query="
SELECT table_name
FROM information_schema.tables
WHERE
    table_schema = '${MysqlBase}' AND
    Engine = '${EngineFrom}'
;
"
    tableList="$( mysql_cmd "$query" )"

    [ -z "$tableList" ] && {
        echo -e "\nNenhuma tabela a ser atualizada no banco '${MysqlBase}'."
        return 1
    }
    echo -e "\nUma ou mais tabelas serão alteradas. Executando backup..."

    backup_db

    echo -e "\nAtualizando tabelas $EngineFrom para ${EngineTo}..."
    echo

    echo "$tableList" \
    |
    while read table ; do
        echo "Atualizando '${table}'..."

        mysql_cmd "ALTER TABLE ${MysqlBase}.$table ENGINE=${EngineTo}" ||
            die
    done

    echo -e "\nTabelas atualizadas com sucesso."
}


##
## Entrada
##

# Processamento de argumentos
while [[ $# > 0 ]] ; do
    case $1 in
        --engine-from) [ $2 ] && EngineFrom="$2" && shift || throw_arg_error $1 ;;
        --engine-to  ) [ $2 ] && EngineTo="$2"   && shift || throw_arg_error $1 ;;
        -h|--host    ) [ $2 ] && MysqlHost="$2"  && shift || throw_arg_error $1 ;;
        -d|--database) [ $2 ] && MysqlBase="$2"  && shift || throw_arg_error $1 ;;
        -u|--user    ) [ $2 ] && MysqlUser="$2"  && shift || throw_arg_error $1 ;;
        -p|--password) [ $2 ] && MysqlPass="$2"  && shift || throw_arg_error $1 ;;

        *)
            die "fatal: parâmetro desconhecido: $1"
        ;;
    esac
    shift
done

# Teste de sanidade
[ -z "$MysqlBase" ] && die "fatal: nenhuma base de dados selecionada."

# Cabeçalho
echo "$ProgramName v${ProgramVersion}"
echo "Copyright (c) 2013 Flaudísio Tolentino"

# Atualiza tabelas
update_tables


exit 0
