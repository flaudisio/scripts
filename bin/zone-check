#!/bin/bash
#
# zone-check
# Testa arquivos de zonas do BIND
#
# Autor     : Flaudísio Tolentino <flaudisio@flaudisio.com>
# Data      : Tue Aug  6 15:03:35 BRT 2013
# Licença   : GPLv2
#
##

die() { echo -e "$*" >&2 ; exit 1 ; }

[ $# -lt 1 ] &&
    die "fatal: missing operand."

[ ! which named-checkzone > /dev/null 2>&1 ] &&
    die "fatal: named-checkzone not found."

[ ! -d /etc/bind/zones ] &&
    die "fatal: BIND zones folder not found."

## Settings

# Colors
R="\e[31m"
G="\e[32m"
N="\e[m"

## Functions

_check() {
    named-checkzone $1 /etc/bind/zones/${1}.db > /dev/null 2>&1

    [ $? -eq 0 ] &&
        echo -en "[ ${G}OK${N} ] " \
    ||
        echo -en "[${R}FAIL${N}] "

    echo $1
}

## Main

echo -e "\nStarting BIND Zone Check at $( date )\n"

if [ "$1" = "-a" ] ; then
    ls -1 /etc/bind/zones/*.db |
    while read file ; do
        domain="$( basename "$file" | sed 's/\.db$//' )"

        _check $domain
    done
else
    while [ $# -gt 0 ] ; do
        _check $1
        shift
    done
fi


echo -e "\nDone.\n"

exit 0
